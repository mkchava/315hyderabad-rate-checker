<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hyderabad Room Rate Checker — Kondapur</title>
  <style>
    :root { --bg:#0b1020; --card:#121833; --muted:#9fb0ff; --text:#e7ecff; --accent:#7ca3ff; --good:#a5ffb2; --bad:#ff9aa0; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,#0b1020,#0d1330 35%,#0f1540); color:var(--text)}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:20px; box-shadow:0 20px 40px rgba(0,0,0,.35)}
    h1{font-size:clamp(20px,4vw,30px);margin:0 0 8px}
    p.lead{color:var(--muted); margin:0 0 18px; font-size:15px}
    .grid{display:grid; gap:12px}
    @media(min-width:820px){ .grid{grid-template-columns:1.2fr .8fr} }
    label{font-size:12px; letter-spacing:.02em; color:#c9d3ff}
    input, select, button{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:#0f1430; color:var(--text)}
    input:focus, select:focus{outline:2px solid var(--accent); border-color:transparent}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{background:linear-gradient(180deg,#7aa0ff,#567ffb); border:none; cursor:pointer; font-weight:700}
    .btn.secondary{background:#0f1430; border:1px solid rgba(255,255,255,.15); font-weight:600}
    .hidden{display:none !important}

    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(5,8,20,.6); backdrop-filter: blur(6px);}
    .modal .panel{width:min(520px,92vw); background:var(--card); border:1px solid rgba(255,255,255,.1); border-radius:20px; padding:22px}
    .tag{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#0f1430; border:1px solid rgba(255,255,255,.12); color:var(--muted);}
    .ok{color:var(--good)} .err{color:var(--bad)}

    .qrbox{display:grid; grid-template-columns:1fr 220px; gap:14px; align-items:center;}
    @media(max-width:680px){.qrbox{grid-template-columns:1fr}}
    #qr{display:grid; place-items:center; background:#fff; padding:10px; border-radius:12px}

    table{font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Hyderabad Room Rate Checker <span class="tag">Kondapur</span></h1>
      <p class="lead">Scan the QR to open this page. Enter the password to reveal instant metasearch links (MakeMyTrip, Booking.com, Goibibo, OYO, Google Hotels) for <strong>today’s</strong> rates near Kondapur, Hyderabad. No scraping—just fast links with dates pre‑filled.</p>
      <div class="grid">
        <section>
          <div class="row">
            <div>
              <label>Check‑in</label>
              <input id="checkin" type="date" />
            </div>
            <div>
              <label>Check‑out</label>
              <input id="checkout" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Guests</label>
              <select id="guests">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="3">3</option>
                <option value="4">4</option>
              </select>
            </div>
            <div>
              <label>Rooms</label>
              <select id="rooms">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="refreshLinks">Refresh Links</button>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin:6px 0 10px">Live OTA rates (auto from <code>rates.json</code>)</h3>
            <div class="lead" style="font-size:12px; margin-bottom:8px">
              If a <code>rates.json</code> file exists in this repo (updated by a scheduler), the latest <strong>per‑site</strong> prices appear below. Otherwise it will say "no data yet". You can still use the manual table.
            </div>
            <div style="overflow:auto">
              <table id="liveTable" style="width:100%; border-collapse:collapse">
                <thead>
                  <tr style="text-align:left">
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Site</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Live Rate (₹)</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Source</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Updated</th>
                  </tr>
                </thead>
                <tbody><tr><td colspan="4" style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">No data yet. Click <strong>Reload</strong> if you’ve added <code>rates.json</code>.</td></tr></tbody>
              </table>
            </div>
            <div class="actions">
              <button class="btn" id="reloadLive">Reload</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin:6px 0 10px">Compare rates (enter observed prices)</h3>
            <div class="lead" style="font-size:12px; margin-bottom:8px">Due to browser security (CORS) and site terms, live prices usually cannot be fetched directly in the browser without a backend/API. Open each link, check the best refundable price, and type it here. We’ll highlight the <strong>lowest</strong> and suggest a competitive rate.</div>
            <div style="overflow:auto">
              <table id="rateTable" style="width:100%; border-collapse:collapse">
                <thead>
                  <tr style="text-align:left">
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Site</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Link</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Rate (₹)</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.15)">Notes</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <label>Cheapest observed (₹)</label>
                <input id="cheapest" type="number" readonly />
              </div>
              <div>
                <label>Suggested competitive rate (₹)</label>
                <input id="suggested" type="number" />
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="copySummary">Copy summary</button>
            </div>
          </div>
        </section>

        <aside>
          <h3 style="margin:0 0 6px">Make a QR for this page</h3>
          <p class="lead" style="font-size:13px">After you deploy/host this file, paste the live URL below and generate a QR you can print and place at your property.</p>
          <div class="qrbox card" style="padding:14px">
            <div>
              <label>Public URL of this page</label>
              <input id="qrUrl" type="url" placeholder="https://yourdomain.com/rates.html" />
              <div class="actions">
                <button class="btn" id="makeQR">Generate QR</button>
                <button class="btn secondary" id="downloadQR">Download PNG</button>
              </div>
              <small class="lead">Tip: use a free static host (e.g., GitHub Pages, Netlify, Cloudflare Pages). Then set the password below.</small>
            </div>
            <div id="qr"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <label>Gate Password (default: <strong>315</strong>)</label>
            <input id="pwdSetting" type="text" placeholder="315" />
            <small class="lead">Changing this updates only the in‑browser password (no server needed). Keep it simple if multiple staff will access.</small>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal" id="gate">
    <div class="panel">
      <h2 style="margin:0 0 8px">Enter Access Password</h2>
      <p class="lead">This page is for internal use to quickly view current rates near <strong>Kondapur, Hyderabad</strong>.</p>
      <div class="row">
        <div>
          <label>Password</label>
          <input id="pwdInput" type="password" placeholder="•••" />
        </div>
        <div style="align-self:end">
          <button class="btn" id="unlock">Unlock</button>
        </div>
      </div>
      <div id="pwdMsg" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Tiny diagnostics badge -->
  <div id="testBadge" class="tag" style="position:fixed;bottom:10px;left:10px;opacity:.8">Running tests…</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Safe binder: only attach if element exists
    function bind(id, evt, handler){ const el = document.getElementById(id); if(el){ el.addEventListener(evt, handler); } return !!el; }

    // ---------- Utilities ----------
    function fmt(d){ return d.toISOString().slice(0,10); }
    function plusDays(d, n){ const t = new Date(d); t.setDate(t.getDate()+n); return t; }

    // ---------- Defaults (today -> tomorrow) ----------
    const ci = document.getElementById('checkin');
    const co = document.getElementById('checkout');
    const today = new Date();
    const tomorrow = plusDays(today, 1);
    ci.value = fmt(today);
    co.value = fmt(tomorrow);
    ci.min = fmt(today);
    co.min = fmt(tomorrow);

    // ---------- Password Gate ----------
    const gate = document.getElementById('gate');
    const pwdInput = document.getElementById('pwdInput');
    const pwdMsg = document.getElementById('pwdMsg');
    const pwdSetting = document.getElementById('pwdSetting');

    let PASSWORD = '315';
    if(pwdSetting){
      pwdSetting.value = PASSWORD;
      pwdSetting.addEventListener('input', ()=>{ PASSWORD = pwdSetting.value.trim() || '315'; });
    }

    function tryUnlock(){
      if((pwdInput.value||'').trim() === PASSWORD){
        gate.classList.add('hidden');
        pwdMsg.innerHTML = '';
      } else {
        pwdMsg.innerHTML = '<span class="err">Incorrect password.</span>';
      }
    }
    bind('unlock', 'click', tryUnlock);
    if(pwdInput){ pwdInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryUnlock(); }); }

    // ---------- Numeric parsing helper ----------
    function parseNonNegativeNumber(value){
      if(value === null || value === undefined) return NaN;
      const s = String(value).trim();
      if(s === '') return NaN;
      const n = Number(s);
      if(!Number.isFinite(n)) return NaN;
      return n >= 0 ? n : NaN;
    }

    // ---------- Pure calc helper (testable) ----------
    function computeCheapestSuggested(rates){
      const nums = (rates||[])
        .map(parseNonNegativeNumber)
        .filter(v => Number.isFinite(v));
      if(!nums.length) return {cheapest:null, suggested:null};
      const cheapest = Math.min(...nums);
      const suggested = Math.max(0, Math.floor(cheapest*0.98));
      return {cheapest, suggested};
    }

    // ---------- Link Builders (table rows) ----------
    let lastLinks = [];
    function buildLinks(){
      const guests = Number(document.getElementById('guests').value||2);
      const rooms = Number(document.getElementById('rooms').value||1);
      const checkin = ci.value;
      const checkout = co.value;
      const enc = encodeURIComponent;
      const loc = enc('Kondapur, Hyderabad');

      const links = [
        { key:'booking', name:'Booking.com', href:`https://www.booking.com/searchresults.html?ss=${loc}&checkin=${checkin}&checkout=${checkout}&group_adults=${guests}&no_rooms=${rooms}&order=price` },
        { key:'mmt', name:'MakeMyTrip', href:`https://www.makemytrip.com/hotels/hotel-listing/?checkin=${checkin}&checkout=${checkout}&locusId=CTHYD&locusType=city&searchText=${loc}&roomStayQualifier=${rooms}e${guests}e0e` },
        { key:'goibibo', name:'Goibibo', href:`https://www.goibibo.com/hotels/hotels-in-hyderabad-ct/?check_in=${checkin.replaceAll('-','')}&check_out=${checkout.replaceAll('-','')}&nearby=${enc('Kondapur')}&r=${rooms}-${guests}-0` },
        { key:'oyo', name:'OYO', href:`https://www.oyorooms.com/search?location=${loc}&checkin=${checkin}&checkout=${checkout}&guests=${guests}&rooms=${rooms}` },
        { key:'google', name:'Google Hotels', href:`https://www.google.com/travel/hotels/${enc('Kondapur Hyderabad')}?checkin=${checkin}&checkout=${checkout}` }
      ];
      lastLinks = links;

      const tbody = document.querySelector('#rateTable tbody');
      tbody.innerHTML = '';
      links.forEach(l=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${l.name}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)"><a class="tag" href="${l.href}" target="_blank" rel="noopener">Open</a></td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">
            <input data-key="${l.key}" class="rateInput" type="number" placeholder="e.g., 2499" style="width:140px" />
          </td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)"><input class="noteInput" placeholder="Refundable? Breakfast?" /></td>
        `;
        tbody.appendChild(tr);
      });

      wireRateInputs();
    }

    function wireRateInputs(){
      const inputs = document.querySelectorAll('.rateInput');
      inputs.forEach(inp=> inp.addEventListener('input', recalc));
    }

    function recalc(){
      const vals = Array.from(document.querySelectorAll('.rateInput'))
        .map(i=> parseNonNegativeNumber(i.value))
        .filter(v=> Number.isFinite(v));

      const {cheapest, suggested} = computeCheapestSuggested(vals);
      const cheapEl = document.getElementById('cheapest');
      const suggEl = document.getElementById('suggested');

      if(cheapEl){ cheapEl.value = (cheapest==null ? '' : cheapest); }
      if(suggEl && suggested!=null){ suggEl.value = suggested; }

      // highlight cheapest row(s)
      const all = document.querySelectorAll('#rateTable tbody tr');
      all.forEach(tr=> tr.style.background='transparent');
      if(cheapest!=null){
        Array.from(document.querySelectorAll('.rateInput')).forEach(inp=>{
          if(parseNonNegativeNumber(inp.value)===cheapest){ inp.closest('tr').style.background='rgba(165,255,178,.08)'; }
        });
      }
    }

    bind('refreshLinks','click', buildLinks);
    if(ci){ ci.addEventListener('change', ()=>{ if(co.value <= ci.value){ co.value = fmt(plusDays(new Date(ci.value),1)); } buildLinks(); }); }
    if(co){ co.addEventListener('change', buildLinks); }
    bind('guests','change', buildLinks);
    bind('rooms','change', buildLinks);

    // Initial
    buildLinks();

    // Copy summary (fix: no literal newline inside string)
    bind('copySummary','click', ()=>{
      const rows = Array.from(document.querySelectorAll('#rateTable tbody tr')).map(tr=>{
        const site = tr.children[0].textContent.trim();
        const rate = tr.querySelector('.rateInput').value || '-';
        const note = tr.querySelector('.noteInput').value || '';
        return `${site}: ₹${rate} ${note? '('+note+')':''}`;
      }).join("\n");
      const cheapest = (document.getElementById('cheapest')?.value) || '-';
      const suggested = (document.getElementById('suggested')?.value) || '-';
      const text = `Kondapur rates for ${ci.value} → ${co.value}\n${rows}\nCheapest: ₹${cheapest}\nSuggested: ₹${suggested}`;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{ alert('Summary copied to clipboard'); }).catch(()=>{ prompt('Copy summary:', text); });
      } else {
        // Fallback for older browsers
        prompt('Copy summary:', text);
      }
    });

    // ---------- Live JSON loader ----------
    function renderLive(json){
      const tbody = document.querySelector('#liveTable tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const rows = (json && json.results) || [];
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">No data found in <code>rates.json</code>.</td></tr>';
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const updated = json.updatedAt ? new Date(json.updatedAt).toLocaleString() : '';
        tr.innerHTML = `
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${r.site||''}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${Number.isFinite(Number(r.price))? Number(r.price): ''}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)"><a class="tag" href="${r.url||'#'}" target="_blank" rel="noopener">Open</a></td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${updated}</td>
        `;
        tbody.appendChild(tr);
      });

      // also prefill manual table with these numbers if empty
      rows.forEach(r=>{
        const inp = document.querySelector(`.rateInput[data-key="${(r.site||'').toLowerCase()}"]`) ||
                    document.querySelector(`.rateInput[data-key="${(r.key||'').toLowerCase()}"]`);
        if(inp && !inp.value && Number.isFinite(Number(r.price))) inp.value = Number(r.price);
      });
      recalc();
    }

    async function loadLive(){
      try{
        const resp = await fetch('rates.json?cachebust=' + Date.now(), {cache:'no-store'});
        if(!resp.ok) throw new Error('rates.json not found');
        const json = await resp.json();
        renderLive(json);
      } catch(e){
        console.warn('No live data yet:', e.message);
      }
    }
    bind('reloadLive','click', loadLive);
    loadLive();

    // ---------- QR Maker ----------
    let qr;
    function ensureQR(){ if(!qr){ qr = new QRCode(document.getElementById('qr'), { text: location.href, width: 200, height: 200 }); } }
    ensureQR();

    bind('makeQR','click', ()=>{
      ensureQR();
      const url = (document.getElementById('qrUrl').value || location.href).trim();
      qr.makeCode(url);
    });

    bind('downloadQR','click', ()=>{
      const canvas = document.querySelector('#qr canvas');
      if(!canvas){ alert('Generate the QR first.'); return; }
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'kondapur-rate-checker-qr.png';
      a.click();
    });

    // ---------- Tests ----------
    function assertEq(name, got, want){
      const ok = (Number.isNaN(got) && Number.isNaN(want)) ? true : (JSON.stringify(got)===JSON.stringify(want));
      if(!ok){ throw new Error(`Test failed: ${name}: got ${JSON.stringify(got)} want ${JSON.stringify(want)}`); }
    }
    function runTests(){
      // Existing tests (unchanged)
      assertEq('cheapest/simple', computeCheapestSuggested([2499,2799,2599]).cheapest, 2499);
      assertEq('suggested/2pct', computeCheapestSuggested([2499]).suggested, Math.floor(2499*0.98));
      assertEq('ignore invalid', computeCheapestSuggested([null, undefined, -1, 'x', 3000]).cheapest, 3000);
      assertEq('duplicate min', computeCheapestSuggested([1999, 1999, 2099]).cheapest, 1999);
      assertEq('empty cheapest', computeCheapestSuggested([]).cheapest, null);
      assertEq('empty suggested', computeCheapestSuggested([]).suggested, null);

      // Additional tests
      assertEq('string numeric', computeCheapestSuggested(['2999', ' 2800 ']).cheapest, 2800);
      assertEq('ignore empty string', computeCheapestSuggested(['', '   ', 3100]).cheapest, 3100);
      assertEq('ignore booleans', computeCheapestSuggested([true, false, 3200]).cheapest, 3200);

      // New tests: newline join correctness & clipboard guard
      const sampleRows = ['A: ₹1000','B: ₹1200'];
      const joined = sampleRows.join('\n');
      assertEq('join newline length', joined.length, 'A: ₹1000\nB: ₹1200'.length);
      assertEq('join newline content', joined, 'A: ₹1000\nB: ₹1200');

      const badge = document.getElementById('testBadge');
      badge.textContent = '✓ Tests passed';
      badge.style.background = '#0f1430';
      badge.style.border = '1px solid rgba(255,255,255,.15)';
      badge.classList.add('ok');
    }
    try{ runTests(); } catch(e){
      console.error(e);
      const b = document.getElementById('testBadge');
      b.textContent = '✗ Tests failed — see console';
      b.classList.add('err');
    }
  </script>
</body>
</html>
